# Template file for 'CalculiX-ccx'
pkgname=CalculiX-ccx
version=2.20
revision=1
wrksrc=CalculiX
build_wrksrc="ccx_${version}/src"
hostmakedepends="gcc-fortran"
makedepends="spooles arpack-ng-devel libgomp-devel openblas-devel"
short_desc="3D Structural Finite Element Program - Solver"
maintainer="Phicem <phicem@gmx.com>"
license="GPL-2.0-or-later"
homepage="http://www.dhondt.de/"
distfiles="http://www.dhondt.de/ccx_${version}.src.tar.bz2"
checksum=63bf6ea09e7edcae93e0145b1bb0579ea7ae82e046f6075a27c8145b72761bcf

FFLAGS="-fallow-argument-mismatch"
CFLAGS="-I${XBPS_CROSS_BASE}/usr/include/spooles -DARCH=Linux -DSPOOLES -DARPACK -DMATRIXSTORAGE -DNETWORKOUT"

post_patch() {
	vsed -e 's,./date.pl; ,,' -i Makefile
	# taken from date.pl, changed for reproducibility
	vsed -e 's/You are using an executable made on.*/You are using an executable made on '"$(date --utc --date @$SOURCE_DATE_EPOCH +%Y-%m-%d)"'\\n");/g' \
		-i ccx_$version.c -i CalculiXstep.c
	vsed -e 's/COMPILETIME.*/COMPILETIME       '"$(date --utc --date @$SOURCE_DATE_EPOCH +%Y-%m-%d)"'\\n",p1);/g' \
		-i frd.c
}

do_build() {
	make CC="$CC" FC="$FC" CFLAGS="$CFLAGS" FFLAGS="$FFLAGS" \
		LIBS="${XBPS_CROSS_BASE}/usr/lib/spooles.a ${XBPS_CROSS_BASE}/usr/lib/libarpack.so ${XBPS_CROSS_BASE}/usr/lib/libopenblas.so -lpthread -lm -lc"
}

do_install() {
	vbin ccx_${version} ccx
}
